name: CI Pipeline

on: 
    push:
      branches: [ "main" ]
    pull_request:
      branches: [ "main" ]

jobs:
    build:
      runs-on: ubuntu-latest

      steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set Up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache Maven Packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('todapp-swe451/pom.xml') }}
          restore-keys: | 
            ${{ runner.os }}-maven-

      - name: List Files (debugging)
        run: ls -R

      - name: Compile Project
        run: mvn compile
        working-directory: ./todoapp-swe451

      - name: Run Unit Tests
        run: mvn test
        working-directory: ./todoapp-swe451

      - name: Build with Maven (skip repackaging issues)
        run: mvn clean install -DskipTests -Dspring-boot.repackage.skip=true
        working-directory: ./todoapp-swe451

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: todoapp-jar
          path: ./todoapp-swe451/target/*.jar

        deploy:
          needs: build-and-test
          runs-on: ubuntu-latest

          steps:
          - name: Download Artifact
            uses: actions/download-artifact@v4
            with:
              name: todoapp-jar
              path: ./deploy

          - name:
            run: |
              echo "EC2 HOST: ${{ secrets.EC2_Host }}

          - name: Set up SSH
            run: |
              mkdir -p ~/.ssh
              echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
              chmod 600 ~/.ssh/id_rsa
              ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts
    
          - name: Deploy JAR to EC2
            run: |
              scp ./deploy/*.jar ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/${{ secrets.EC2_USER }}/todoapp-swe451/todoapp.jar
              ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "pkill -f 'java -jar' || true && nohup java -jar /home/${{ secrets.EC2_USER }}/todoapp-swe451/todoapp.jar > /home/${{ secrets.EC2_USER }}/todoapp/app.log 2>&1 &"
    
